<section class="section_gap">
  <div class="container">
    <div class="row mb-4">
      <div class="col-12 text-center">
        <h2>{{ section.settings.main_heading }}</h2>
        <p id="wishlist-empty-message" class="text-muted d-none">{{ section.settings.empty_text }}</p>
        <a href="{{ section.settings.return_url }}" class="main_btn d-none" id="return-to-shopping">
          {{- section.settings.return_button_text -}}
        </a>
      </div>
    </div>

    <div class="row" id="wishlist-container">
      <!-- Will be populated by JS -->
    </div>
  </div>
</section>

<script>
  function getWishlist() {
    return JSON.parse(localStorage.getItem('wishlist') || '[]');
  }

  function saveWishlist(wishlist) {
    localStorage.setItem('wishlist', JSON.stringify(wishlist));
  }

  window.removeFromWishlist = function(productId) {
    const wishlist = getWishlist().filter(id => id !== productId);
    saveWishlist(wishlist);
    renderWishlist();
  }

  function renderWishlist() {
    const wishlist = getWishlist();
    const container = document.getElementById('wishlist-container');
    const emptyMessage = document.getElementById('wishlist-empty-message');
    const returnBtn = document.getElementById('return-to-shopping');
    
    container.innerHTML = '';

    if (wishlist.length === 0) {
      emptyMessage.classList.remove('d-none');
      returnBtn.classList.remove('d-none');
      return;
    } else {
      emptyMessage.classList.add('d-none');
      returnBtn.classList.add('d-none');
    }

    // Shopify Liquid generates the product_data map
    const productData = {
      {% for p in collections.all.products %}
        "{{ p.id }}": {
          id: {{ p.id }},
          url: "{{ p.url }}",
          title: "{{ p.title | escape }}",
          img: "{{ p.featured_image | img_url: '400x' }}",
          price: "{{ p.price | money }}"
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    };

    wishlist.forEach(id => {
      const prod = productData[id];
      if (prod) {
        const productCard = `
          {% render 'product-card', product: '__PRODUCT__' %}
        `.replace(/__PRODUCT__/g, JSON.stringify({ id: prod.id, url: prod.url, title: prod.title, featured_image: prod.img, price: prod.price }));

        container.insertAdjacentHTML('beforeend', `
          <div class="col-lg-4 col-md-6 mb-4">
            ${productCard}
            <button class="main_btn" onclick="removeFromWishlist(${prod.id})">Remove</button>
          </div>
        `);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', renderWishlist);
</script>

{% schema %}
{
  "name": "Wishlist",
  "settings": [
    {
      "type": "text",
      "id": "main_heading",
      "label": "Main Heading",
      "default": "Wishlist"
    },
    {
      "type": "text",
      "id": "empty_text",
      "label": "Empty Wishlist Text",
      "default": "Your wishlist is empty. Add items to see them here!"
    },
    {
      "type": "url",
      "id": "return_url",
      "label": "Return to Shopping URL",
      "default": "/collections/all"
    },
    {
      "type": "text",
      "id": "return_button_text",
      "label": "Return Button Text",
      "default": "Return to Shopping"
    }
  ],
  "presets": [
    {
      "name": "Wishlist Section",
      "category": "Custom"
    }
  ]
}
{% endschema %}
